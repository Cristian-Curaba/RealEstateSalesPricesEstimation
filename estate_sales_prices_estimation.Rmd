---
title: "Estimation of Iranian Real Estate Units Sale Prices"
author: "C. Curaba, Y. Martínez Jiménez, E. Stefanel"
date: "2023-01-31"
output:
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  eval=TRUE, echo=FALSE, warning=FALSE,
  message=FALSE, fig.align='center')
```


## Assignment statement

The [**Residential Building Data Set**](https://archive.ics.uci.edu/ml/datasets/Residential+Building+Data+Set)
has been donated by Ph.D. Mohammad H. Rafiei from The Ohio State University,
Columbus, and includes $372$ observations about real estate single-family
residential apartments in Tehran, Iran. In particular, for each apartment are
reported $8$ project physical and financial variables and $19$ economic variables
and indices. This $19$ features are reported in $5$ time lag^[The number of
*time resolutions* before the start of the project.], leading a total of $103$
possible explanatory variables for the two output variables, that are
`ConstructionCosts` and `SalesPrices`.

The aim of the present project is to build an efficient pipeline to estimate
the `SalesPrices`, observing the explanatory variables. In order to do that, we
start by analyzing the dataset and performing some feature engineering. We then
study some possible statistical model for the estimation. Finally, we conclude
by summarizing the results and proposing some possible future improvement.


## Data analysis

The first thing we do after importing the dataset from the original repository
is to rename the columns in a more friendly and informative way. This is done by
following the description of the features in the `Description` sheet of the
Excel file.

```{r dataset_import}
# Import needed libraries for the Features Engineering part
library(dplyr)    # Base R package for Data Manipulation
library(openxlsx) # Allows reading Excel files from URL
library(ggplot2)  # Allows plotting advanced graphs

# Read the Constructions data from `archive.ics.uci.edu`
Constructions <- read.xlsx(
  'https://archive.ics.uci.edu/ml/machine-learning-databases/00437/Residential-Building-Data-Set.xlsx',
  sheet=1,
  startRow=2)

# Rename columns according to the descriptions in the Excel file
colnames(Constructions)[1:4] <- c("StartYear", "StartQuarter", "CompletionYear", "CompletionQuarter")
colnames(Constructions)[5:12] <- c("BuildingZIPCode", "BuildingFloorArea", "LotArea", "TotEstConstructionCost", "EstConstructionCost", "EstConstructionCostBaseYear", "ConstructionDuration", "PriceAtBeginning")

for (lag in 1:5) {
  colnames(Constructions)[(13+19*(lag-1)):(13+19*lag-1)] <- paste(
    c("BuildingPermitsNo", "BSI", "WPI", "BuildingPermitsFloorArea", "CumulativeLiquidity", "PrivateSectorInvestment", "LandPriceIndexBaseYear", "LoansExtendedNo", "LoansExtendedAmount", "InterestRate", "ConstructionCostAtCompletion", "ConstructionCostAtBeginning", "OfficialExcangeRateUSD", "StreetMarketExcangeRateUSD", "CPIBaseYear", "CPIFornituresBaseYear", "StockMarketIndex", "CityPopulation", "GoldPriceOnce"),
    lag, sep='_')
    rm(lag)
}

colnames(Constructions)[108:109] <- c("SalesPrices", "ConstructionCosts")

# Remove the `ConstructionCosts` column from the dataframe
Constructions <- Constructions %>% 
  select(-c("ConstructionCosts"))

head(Constructions)
```

We are now going to list all the dataframe columns and explain their meanings:

* `StartYear`, `StartQuarter`, `CompletionYear` and `CompletionQuarter` are temporal
references about the Building project. Only the last two digits of the years are
reported, so we will add $1300$ to each year (keeping in mind that dates are
referring to the Persian calendar);
* `BuildingZIPCode` is the ZIP Code where the Building is located,.
`BuildingFloorArea` and `LotArea` are surfaces values, measured in square meters,
referring to the construction lot. `TotEstConstructionCost`,
`EstConstructionCost` and `EstConstructionCostBaseYear` are total construction
cost, in ten thousands Rial (Iranian currency), actual and estimated at the
beginning of the project (the last is also adjusted to inflation at the
year $1383$). `ConstructionDuration` is the duration, in quarters, of the
constructions, and `PriceAtBeginning` is the specific square root price before
the construction start. This are Building-specific features that do not change
during the construction period;
* There is then a set of $19$ features that are measured at five regular
intervals from the construction starting date and the completion date. Each of
them will then be present in the dataframe for a total of five times.
`BuildingPermitsNo` is the number of building permits issued, `BSI` and `WPI` are
Building Services Index and Wholesale Price Index, `BuildingPermitsFloorArea` is
the total floor areas, in square meters, of building permits issued by the city.
`CumulativeLiquidity` represents, in ten milions of Rial, how rapidly different
types of assets can be changed to cash, `PrivateSectorInvestment` is the sector
investment in new buildings, `LandPriceIndexBaseYear` is the square root price
in year $1383$. The columns `LoansExtendedNo`, `LoansExtendedAmount` and
`InterestRate` refers to extended loans during the lag.
`ConstructionCostAtCompletion` and `ConstructionCostAtBeginning` are average
construction cost of buildings by private sector at the time of completion and
beginning of construction. `OfficialExcangeRateUSD` and `StreetMarketExcangeRateUSD`
are official and nonofficial (street market) exchange rate with respect to dollars.
`CPIBaseYear` and `CPIFornituresBaseYear` are respectively total Consumer Price
Index and CPI only related to fornitures.
`StockMarketIndex` represent the payback condition of investment in stock market,
`CityPopulation` the population of the city and `GoldPriceOnce` gold price, in
Rial, per ounce;
* `SalesPrices` and `ConstructionCosts` are the two response variables,
indicating the final selling price of the estate and total construction costs,
respectively. Both measures use $10000$ Rial as measure unit.

Now that we understand what the individual columns refer to, we can analyze
which variables are qualitative (ordered or not), and which are quantitative
(discrete or continuous).

The first thing that we note is that there are no qualitative columns in the
dataset. The only columns that could be interpreted as factor column are the
`StartQuarter` and `CompletionQuarter` ones, where only value from $1$ to $4$
are possible, and `BuildingZIPCode` with values from $1$ to $20$.
All the other variables are continuous quantitative measures.

```{r factor_columns}
# Treat `BuildingZIPCode` variable as factor
Constructions$BuildingZIPCode <- as.factor(Constructions$BuildingZIPCode)

# We do not compute the same operation on `StartQuarter` and `CompletionQuarter`
# columns since, as we will see in a couple of chunks, we will drop that
# specific features.
```

Next, we proceed to check whether any records contain any missing columns.
If so, we will decide how to handle it.

```{r missing_values}
column_with_missing_values = c()

for (column in colnames(Constructions)) {
  missing_values <- Constructions %>% 
    select(column) %>% 
    is.na() %>% 
    sum()
  
  if (missing_values > 0) {
    column_with_missing_values <- c(column_with_missing_values, column)
  }
}

if (length(column_with_missing_values) > 0) {
  print("There are columns with missing values!")
} else
{
  print("There are no columns with missing values!")
}

rm(column, missing_values, column_with_missing_values)
```

Fortunately, there are no columns where missing values occur. This can be
because a preventive data cleaning has been done by the person who uploaded the
dataframe on the public repository, or because the data collection method was
meticulous and error-free. We lean toward the first of the two options.

We note that we could implode years and quarters information into a single value,
one for starting date and one for completion date. This is done by simply adding
$.25$ to each year value for each ended quarter of the current year at the start
(or completion) of the project. In this way, the first quarter of the $x$ year
will be $x.00$, the second quarter will be $x.25$, and so on.

```{r feature_engineering}
# Explode the Years (abbreviated to the last two digits in the original dataframe) and add .25 year per Quarter
Constructions$StartYear <- ( Constructions$StartYear + 1300 ) + .25 * ( Constructions$StartQuarter - 1 )
Constructions$CompletionYear <- ( Constructions$CompletionYear + 1300 ) + .25 * ( Constructions$CompletionQuarter - 1 )

# Remove the `StartQuarter` and `CompletionQuarter` from the dataframe
Constructions <- Constructions %>% 
  select(-c("StartQuarter", "CompletionQuarter"))
```

We now analyze the distribution of the response variable in the dataset.
Plotting the histogram, and analyzing mean and variance can help us.

```{r salesprices_hist}
summary(Constructions$SalesPrices)

Constructions %>%
  ggplot(aes(x=SalesPrices)) + 
  geom_histogram() +
  geom_vline(aes(xintercept=mean(SalesPrices),color='mean'), linetype="dashed", size=.5) +
  geom_vline(aes(xintercept=median(SalesPrices),color='median'), linetype="dashed", size=.5) +
  scale_color_manual(name = "Statistics", values = c(mean = "red", median = "blue")) +
  labs(
    title='Sales prices histogram plot',
    subtitle='Distribution of Sales prices in the Constructions dataframe',
    caption="Data from archive.ics.uci.edu",
    x=expression("Sales prices (" %*% ~ 10^4 ~ "Rial)" ),
    y='Count'
  ) +
  theme_classic()
```

The distribution of `SalesPrices` values in the dataframe is highly skewed
towards left. We can try to plot the same histogram, but applying a logarithmic
scale to the vector of values.

```{r salesprices_log_hist}
Constructions %>%
  ggplot(aes(x=SalesPrices)) + 
  geom_histogram() +
  scale_x_log10() +
  geom_vline(aes(xintercept=mean(SalesPrices),color='mean'), linetype="dashed", size=.5) +
  geom_vline(aes(xintercept=median(SalesPrices),color='median'), linetype="dashed", size=.5) +
  scale_color_manual(name = "Statistics", values = c(mean = "red", median = "blue")) +
  labs(
    title='Sales prices logaritmic histogram plot',
    subtitle='Distribution of Sales prices in the Constructions dataframe',
    caption="Data from archive.ics.uci.edu",
    x=expression("Sales prices (" %*% ~ 10^4 ~ "Rial)" ),
    y='Count'
  ) +
  theme_classic()
```


## Statistical models

```{r linear_model, echo=TRUE}
# Sample linear model
lm.base <- lm(SalesPrices ~ ., Constructions)

# Print the summary of the fitted linear model
summary(lm.base)
```

## Conclusions

